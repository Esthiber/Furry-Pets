@page "/Producto/EditProducto/{ProductoId:int}"
@using PawfectMatch.Services.Adopciones
@using PawfectMatch.Services.Veterinaria
@inject ProductoService productoService
@inject ProveedoresService proveedoresService
@inject NavigationManager navigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Editar Producto</PageTitle>

<div class="producto-container edit-mode">
    <div class="producto-header">
        <h1 class="producto-title">Editar Producto</h1>
        <div class="producto-actions">
            <button class="btn-secondary" @onclick="VolverAlIndice">
                <i class="fas fa-arrow-left"></i> Volver
            </button>
        </div>
    </div>

    <EditForm Model="@producto" OnValidSubmit="@OnValidSubmit" class="producto-form">
        <DataAnnotationsValidator />
        <ValidationSummary />

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span>@ErrorMessage</span>
            </div>
        }

        <div class="form-grid">
            <!-- Información del producto -->
            <div class="form-section">
                <h2 class="section-title">Detalles del Producto</h2>

                <div class="form-group">
                    <label>Nombre del Producto:</label>
                    <InputText class="form-control" @bind-Value="@producto.Nombre" />
                    <ValidationMessage For="@(() => producto.Nombre)" />
                </div>

                <div class="form-group">
                    <label>Descripción:</label>
                    <InputText class="form-control" @bind-Value="@producto.Descripcion" />
                    <ValidationMessage For="@(() => producto.Descripcion)" />
                </div>

                <div class="form-group">
                    <label>Imagen del Producto:</label>

                    @if (!string.IsNullOrEmpty(producto.ImagenURL))
                    {
                        <div class="image-preview mb-2">
                            <img src="@producto.ImagenURL" alt="Vista previa" />
                        </div>
                    }

                    <InputFile OnChange="HandleFileUpload" accept="image/*" class="form-control" />
                    <InputText class="form-control mt-2" @bind-Value="@producto.ImagenURL" placeholder="O ingrese URL manual" />
                    <small class="text-muted">Puede subir una imagen o ingresar una URL. Formatos: JPG, PNG (Máx. 2MB)</small>
                    <ValidationMessage For="@(() => producto.ImagenURL)" />
                </div>

                <div class="form-group">
                    <label>Precio:</label>
                    <InputNumber class="form-control" @bind-Value="@producto.Precio" />
                    <ValidationMessage For="@(() => producto.Precio)" />
                </div>

                <div class="form-group">
                    <label>Cantidad en Stock:</label>
                    <InputNumber class="form-control" @bind-Value="@producto.Stock" />
                    <ValidationMessage For="@(() => producto.Stock)" />
                </div>

                <div class="form-group">
                    <label>Tipo de Categoría:</label>
                    <InputText class="form-control" @bind-Value="@producto.TipoCategoria" />
                    <ValidationMessage For="@(() => producto.TipoCategoria)" />
                </div>

                <div class="form-group">
                    <label>Proveedor:</label>
                    <InputSelect class="form-control" @bind-Value="@producto.ProveedorId">
                        <option value="">Seleccione un Proveedor</option>
                        @foreach (var proveedor in ListaProveedores)
                        {
                            <option value="@proveedor.ProveedorId">@proveedor.Nombre</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => producto.ProveedorId)" />
                </div>
            </div>
        </div>

        <div class="form-actions mt-4">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public int ProductoId { get; set; }
    public PawfectMatch.Models.Productos producto { get; set; } = new PawfectMatch.Models.Productos();
    public List<PawfectMatch.Models.Proveedores> ListaProveedores { get; set; } = new List<PawfectMatch.Models.Proveedores>();
    public string ErrorMessage { get; set; } = string.Empty;
    private const int MaxFileSize = 2 * 1024 * 1024; // 2MB

    protected override async Task OnInitializedAsync()
    {
        ListaProveedores = await proveedoresService.ListarProveedores();
        await LoadProducto();
    }

    private async Task LoadProducto()
    {
        try
        {
            producto = await productoService.SearchByIdAsync(ProductoId);

            if (producto == null)
            {
                navigationManager.NavigateTo("/Producto/IndexAdmin");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Ocurrió un error al cargar el producto: {ex.Message}";
        }
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;

            // Validar tamaño
            if (file.Size > MaxFileSize)
            {
                ErrorMessage = "El archivo es demasiado grande (Máx. 2MB)";
                return;
            }

            // Validar tipo de archivo
            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };
            var fileExtension = Path.GetExtension(file.Name).ToLower();

            if (!allowedExtensions.Contains(fileExtension))
            {
                ErrorMessage = "Formato de imagen no soportado. Use JPG, PNG o GIF";
                return;
            }

            // Crear nombre único para el archivo
            var fileName = $"{Guid.NewGuid()}{fileExtension}";
            var folderPath = Path.Combine("wwwroot", "uploads", "productos");
            var fullPath = Path.Combine(Directory.GetCurrentDirectory(), folderPath);

            // Crear directorio si no existe
            if (!Directory.Exists(fullPath))
            {
                Directory.CreateDirectory(fullPath);
            }

            // Guardar archivo
            var path = Path.Combine(fullPath, fileName);
            await using var stream = new FileStream(path, FileMode.Create);
            await file.OpenReadStream(MaxFileSize).CopyToAsync(stream);

            // Asignar URL relativa al modelo
            producto.ImagenURL = $"/uploads/productos/{fileName}";
            ErrorMessage = string.Empty;

            // Forzar actualización de la vista
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al subir la imagen: {ex.Message}";
        }
    }

    private async Task OnValidSubmit()
    {
        try
        {
            if (await productoService.SaveAsync(producto))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Producto actualizado correctamente");
                navigationManager.NavigateTo("/Producto/IndexAdmin");
            }
        }
        catch (InvalidOperationException ex)
        {
            ErrorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            ErrorMessage = "Ocurrió un error inesperado. Por favor, intenta nuevamente.";
            Console.WriteLine(ex.ToString());
        }
    }

    private void VolverAlIndice()
    {
        navigationManager.NavigateTo("/Producto/IndexAdmin");
    }
}